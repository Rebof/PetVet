<!DOCTYPE html>
<html>
<head>
    <title>Complete Payment</title>
    <script src="https://khalti.com/static/khalti-checkout.js"></script>
    <style>
        .payment-container {
            max-width: 500px;
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
        }
        #pay-button {
            background-color: #5C2D91;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <h2>Complete Payment for Appointment</h2>
        <p>Please complete the payment to confirm your appointment with Dr. {{ appointment.vet.user.full_name }}</p>
        <p>Amount: NPR 10.00</p>
        
        <button id="pay-button">Pay with Khalti</button>
        
        <p style="margin-top: 2rem; font-size: 0.9rem; color: #666;">
            You'll be redirected to Khalti's secure payment page
        </p>
    </div>

    <script>
        var config = {
            "publicKey": "{{ khalti_public_key }}",
            "productIdentity": "appointment-{{ appointment.id }}",
            "productName": "Appointment Confirmation",
            "productUrl": window.location.href,
            "eventHandler": {
                onSuccess(payload) {
                    // Send token to server for verification
                    fetch(`/appointment/verify-payment/{{ appointment.id }}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            token: payload.token,
                            amount: 1000
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = "{% url 'appointment:appointment_detail' appointment.id %}";
                        } else {
                            alert("Payment verification failed: " + data.message);
                        }
                    });
                },
                onError(error) {
                    console.log("Payment error:", error);
                    alert("Payment failed: " + error.message);
                },
                onClose() {
                    console.log("Widget closed");
                }
            }
        };

        var checkout = new KhaltiCheckout(config);
        
        document.getElementById("pay-button").onclick = function() {
            checkout.show({amount: 1000});
        }
    </script>
</body>
</html>