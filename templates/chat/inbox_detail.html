{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<div class="main_content">
    <style>
        /* Base Styles */
        :root {
             --primary-color: #007bff;
             --secondary-color: #6c757d;
             --success-color: #28a745;
             --background-light: #f8f9fa;
             --border-color: #e9ecef;
             --text-dark: #212529;
             --text-light: #ffffff;
         }
 
         .chat-container {
             display: flex;
             height: calc(100vh - 120px);
             background: var(--background-light);
             border-radius: 12px;
             box-shadow: 0 8px 30px rgba(0,0,0,0.12);
             overflow: hidden;
             max-width: 1200px;
             margin: 20px auto;
         }
 
         /* Chat List */
         .chat-list {
             width: 320px;
             background: var(--text-light);
             border-right: 1px solid var(--border-color);
         }
 
         .chat-list-header {
             padding: 20px;
             border-bottom: 1px solid var(--border-color);
             background: var(--background-light);
         }
 
         .chat-list-header h2 {
             margin: 0;
             font-size: 1.5rem;
             color: var(--text-dark);
         }
 
         .chat-list-items {
             height: calc(100% - 61px);
             overflow-y: auto;
         }
 
         .chat-item {
             display: flex;
             align-items: center;
             padding: 16px;
             transition: all 0.2s ease;
             position: relative;
             background: var(--text-light);
         }
 
         .chat-item:hover {
             background: var(--background-light);
             transform: translateX(4px);
             box-shadow: 4px 0 0 var(--primary-color) inset;
         }
 
         .chat-item.active {
             background: var(--background-light);
             box-shadow: 4px 0 0 var(--primary-color) inset;
         }
 
         .chat-avatar {
             width: 48px;
             height: 48px;
             border-radius: 50%;
             margin-right: 16px;
             border: 2px solid var(--border-color);
             object-fit: cover;
         }
 
         .chat-item h4 {
    margin: 0 0 4px 0;
    font-size: 1.1rem;  /* Increased from 1rem */
    color: #111 !important;  /* Pure black instead of variable */
    font-weight: 700 !important;  /* Bold instead of regular bold */
    letter-spacing: 0.3px;
    text-shadow: 0 1px 1px rgba(0,0,0,0.1);  /* Added subtle shadow */
}
 
         .chat-item p {
             margin: 0;
             font-size: 0.875rem;
             color: var(--secondary-color);
             display: -webkit-box;
             
             -webkit-box-orient: vertical;
             overflow: hidden;
             font-size: 0.9rem;
     color: #333; /* Darker color */
         }
 
         /* Chat Window */
         .chat-window {
             flex: 1;
             display: flex;
             flex-direction: column;
             background: var(--text-light);
         }
 
         .chat-header {
             padding: 20px;
             border-bottom: 1px solid var(--border-color);
             background: var(--background-light);
         }
 
         .chat-header h3 {
    margin: 0;
    font-size: 1.3rem;  /* Increased size */
    color: #111 !important;  /* Pure black */
    font-weight: 700 !important;
    padding-bottom: 5px;
}
 
         /* Messages */
         .chat-messages {
             flex: 1;
             padding: 24px;
             overflow-y: auto;
             display: flex;
             flex-direction: column;
             gap: 16px;
         }
 
         .message {
             max-width: 75%;
             padding: 12px 16px;
             border-radius: 16px;
             position: relative;
             line-height: 1.5;
             font-size: 0.9375rem;
             animation: messageAppear 0.3s ease-out;
             font-size: 1rem; /* Slightly increased size */
     color: #333; /* Darker text for better readability */
 }
 
         @keyframes messageAppear {
             from { opacity: 0; transform: translateY(10px); }
             to { opacity: 1; transform: translateY(0); }
         }
 
         .received {
             background: var(--text-light);
     border: none !important; /* Remove any remaining borders */
     align-self: flex-start;
     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Softer shadow */
         }
 
         .sent {
             background: var(--primary-color);
             color: var(--text-light);
             align-self: flex-end;
             border-bottom-right-radius: 4px;
         }
 
         .message span {
             display: block;
             font-size: 0.75rem;
             color: inherit;
             opacity: 0.7;
             margin-top: 8px;
             text-align: right;
         }
 
         /* Input Area */
         .chat-input {
             padding: 20px;
             border-top: 1px solid var(--border-color);
             background: var(--background-light);
         }
 
         .chat-input form {
             display: flex;
             gap: 12px;
             align-items: flex-end;
             display: flex;
     gap: 12px;
     align-items: center;

            
         }
 
         .chat-input textarea {
             flex: 1;
             padding: 12px 16px;
             border: 1px solid var(--border-color);
             border-radius: 8px;
             resize: none;
             min-height: 48px;
             max-height: 120px;
             font-family: inherit;
             font-size: 0.9375rem;
             transition: all 0.2s ease;
             margin: 0;
         }
 
         .chat-input textarea:focus {
             outline: none;
             border-color: var(--primary-color);
             box-shadow: 0 0 0 3px rgba(0,120,255,0.1);
         }
 
         .chat-input button {
             padding: 10px 20px;
             background: var(--primary-color);
             color: var(--text-light);
             border: none;
             border-radius: 8px;
             cursor: pointer;
             transition: all 0.2s ease;
             height: 48px;
             flex-shrink: 0;
     margin: 0;
         }
 
         .chat-input button:hover {
             background: #0069d9;
             transform: translateY(-1px);
         }
 
         /* Unread Badge */
         .unread-badge {
             position: absolute;
             top: 50%;
             right: 16px;
             transform: translateY(-50%);
             width: 8px;
             height: 8px;
             background: var(--primary-color);
             border-radius: 50%;
             box-shadow: 0 0 0 2px var(--text-light);
         }
 
         /* Empty States */
         .empty-state {
             text-align: center;
             padding: 40px 20px;
             color: var(--secondary-color);
         }
 
         @media (max-width: 768px) {
             .chat-list {
                 width: 280px;
             }
             
             .chat-container {
                 height: calc(100vh - 80px);
                 margin: 0;
                 border-radius: 0;
             }
         }
         </style>
    <div class="chat-container">
        <!-- Chat List -->
        <!-- Chat List Items -->
<div class="chat-list-items">
    {% for chat in message_list %}
        {# Determine conversation partner #}
        {% if chat.sender == request.user %}
            {% with partner=chat.receiver %}
                <a href="{% url 'coreFunctions:inbox_details' partner.username %}">
                    <div class="chat-item {% if receiver == partner %}active{% endif %}">
                        <img src="{% static 'assets/images/avatars/avatar-2.jpg' %}" class="chat-avatar">
                        <div>
                            <h4>{{ partner.get_full_name|default:partner.username }}</h4>
                            <p>{{ chat.message|truncatechars:20 }}</p>
                            {% if chat.receiver == request.user and not chat.is_read %}
                                <span class="unread-badge"></span>
                            {% endif %}
                        </div>
                    </div>
                </a>
            {% endwith %}
        {% else %}
            {% with partner=chat.sender %}
                <a href="{% url 'coreFunctions:inbox_details' partner.username %}">
                    <div class="chat-item {% if receiver == partner %}active{% endif %}">
                        <img src="{% static 'assets/images/avatars/avatar-2.jpg' %}" class="chat-avatar">
                        <div>
                            <h4>{{ partner.get_full_name|default:partner.username }}</h4>
                            <p>{{ chat.message|truncatechars:20 }}</p>
                            {% if chat.receiver == request.user and not chat.is_read %}
                                <span class="unread-badge"></span>
                            {% endif %}
                        </div>
                    </div>
                </a>
            {% endwith %}
        {% endif %}
    {% empty %}
        <div class="p-4 text-gray-500">No conversations yet</div>
    {% endfor %}
</div>

        <!-- Chat Window -->
        <div class="chat-window">
            <div class="chat-header">
                <h3>
                    {% if receiver %}
                        Chat with {{ receiver.get_full_name|default:receiver.username }}
                    {% else %}
                        Select a conversation
                    {% endif %}
                </h3>
            </div>
            
            <div class="chat-messages">
                {% if receiver %}
                    {% for message in message_detail %}
                        <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                            <p>{{ message.message }}</p>
                            <span>{{ message.date|time:"H:i" }}</span>
                        </div>
                    {% empty %}
                        <div class="text-center text-gray-500 py-4">No messages yet</div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-gray-500 py-4">Select a conversation to view messages</div>
                {% endif %}
            </div>
            

            {% if receiver %}
                <form method="POST" action="{% url 'coreFunctions:inbox_details' receiver.username %}" class="chat-input" id="chat-f">
                    {% csrf_token %}
                    <textarea id="chat-input-area" name="message" placeholder="Type your message..." required></textarea>
                    <button id="send-btn" type="submit">Send</button>
                </form>
            {% endif %}
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
 document.addEventListener('DOMContentLoaded', function() {
    // Get elements
    const chatForm = document.querySelector('#chat-f');
    const textarea = document.querySelector('#chat-input-area');
    const chatMessages = document.querySelector('.chat-messages');
    
    // Check if elements exist
    if (!chatForm || !textarea || !chatMessages) {
        console.error('Required elements not found!');
        return;
    }

    // Get current and receiver usernames
    const currentUser = "{{ request.user.username }}";
    const receiverUsername = "{{ receiver.username }}";
    
    // Create consistent room name (sorted usernames to ensure same group for both users)
    const roomName = [currentUser, receiverUsername].sort().join('_');
    
    // WebSocket connection
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsPath = `${wsScheme}://${window.location.host}/ws/chat/${roomName}/`;
    let chatSocket = new WebSocket(wsPath);

    // WebSocket event handlers
    chatSocket.onopen = function() {
        console.log('WebSocket connection established for room:', roomName);
    };

    chatSocket.onerror = function(error) {
        console.error('WebSocket error:', error);
    };

    chatSocket.onclose = function() {
        console.log('WebSocket connection closed, attempting to reconnect...');
        setTimeout(function() {
            chatSocket = new WebSocket(wsPath);
        }, 3000);
    };

    // Handle incoming messages
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('Received message:', data);
        if (data.sender === currentUser) return;
        // Only process if this message is relevant to current chat
        if ((data.sender === currentUser && data.receiver === receiverUsername) || 
            (data.sender === receiverUsername && data.receiver === currentUser)) {
            
            const isSent = data.sender === currentUser;
            const messageTime = data.timestamp ? 
                new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 
                new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.innerHTML = `
                <p>${data.message}</p>
                <span>${messageTime}</span>
            `;
            messageDiv.style.animation = 'messageAppear 0.3s ease-out';

            // Append to chat
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Update chat list preview if this is a received message
            if (!isSent) {
                updateChatListPreview(data.sender, data.message);
            }
        }
    };

    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = textarea.value.trim();
        
        if (message && chatSocket.readyState === WebSocket.OPEN) {
            // Create message data
            const messageData = {
                'message': message,
                'sender': currentUser,
                'receiver': receiverUsername,
                'timestamp': new Date().toISOString()
            };

            // Send via WebSocket
            chatSocket.send(JSON.stringify(messageData));
            
            // Also add to UI immediately (optimistic update)
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            messageDiv.innerHTML = `
                <p>${message}</p>
                <span>${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Clear input
            textarea.value = '';
            
            // Update chat list preview
            updateChatListPreview(receiverUsername, message);
        }
    });

    // Update chat list preview
    function updateChatListPreview(username, message) {
        const chatItems = document.querySelectorAll('.chat-item');
        chatItems.forEach(item => {
            const nameElement = item.querySelector('h4');
            if (nameElement && (nameElement.textContent.includes(username) || 
                                nameElement.textContent === username)) {
                // Update last message preview
                const preview = item.querySelector('p');
                if (preview) {
                    preview.textContent = message.length > 20 ? message.substring(0, 20) + '...' : message;
                }
                
                // Add unread badge if this is a received message
                if (username !== currentUser) {
                    let badge = item.querySelector('.unread-badge');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'unread-badge';
                        item.appendChild(badge);
                    }
                }
            }
        });
    }

    // Input validation
    textarea.addEventListener('input', function() {
        const sendBtn = document.querySelector('#send-btn');
        if (sendBtn) {
            sendBtn.disabled = this.value.trim() === '';
        }
    });

    // Initial scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
});
    </script>

{% endblock %}